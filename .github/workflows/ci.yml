name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'
      - name: Run Unit Tests
        run: ./gradlew test --tests '*UnitTest*' --info

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      docker:
        image: docker:20.10.7-dind
        options: --privileged
    steps:
      - uses: actions/checkout@v3
      - name: Checkout secrets repository
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/kitree-secrets
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: secrets
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'
      - name: Copy service account key
        run: |
          mkdir -p src/test/resources
          cp secrets/kitree-lambda/serviceAccountKeyTest.json src/test/resources/test-service-account.json
      - name: Start Firebase Emulator (background)
        run: |
          docker run -d --name firebase-emulator -p 8080:8080 -p 9099:9099 \
            --entrypoint "gcloud" gcr.io/google.com/cloudsdktool/cloud-sdk:latest \
            beta emulators firestore start --host-port=0.0.0.0:8080
      - name: Run Integration Tests
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
        run: ./gradlew test --tests '*IntegrationTest*' --info

  e2e-tests:
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v3
      - name: Checkout secrets repository
        uses: actions/checkout@v3
        with:
          repository: ${{ github.repository_owner }}/kitree-secrets
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          path: secrets
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'
      - name: Copy service account key
        run: |
          mkdir -p src/test/resources
          cp secrets/kitree-lambda/serviceAccountKeyTest.json src/test/resources/test-service-account.json
      - name: Start Firebase Emulator (background)
        run: |
          docker run -d --name firebase-emulator -p 8080:8080 -p 9099:9099 \
            --entrypoint "gcloud" gcr.io/google.com/cloudsdktool/cloud-sdk:latest \
            beta emulators firestore start --host-port=0.0.0.0:8080
      - name: Run End-to-End Tests
        env:
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
        run: ./gradlew test --tests '*EndToEndTest*' --info 